---
params: 
  date: "2023-06-20"
  PARK: "SAGW"
  YEAR: 2023    
title: "Summary of camera trap data, `r params$PARK`, `r params$YEAR`"
date: "`r params$date`"
output:
  officedown::rdocx_document:
    reference_docx: "word-styles-02.docx"
---


```{r setup, include = FALSE}

library(lubridate)
library(tidyverse)
library(terra)
library(spOccupancy)
library(tidyterra)
library(officer)
library(officedown)
library(flextable)

knitr::opts_knit$set(root.dir = "../" )
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  dev = "ragg_png",
  fig.align = "left",
  fig.width = 5, 
  fig.height = 3.5, 
  fig.dpi = 150, 
  fig.cap.style = "Figure caption",
  fig.cap.pre = "Figure ",
  fig.cap.sep = ". ",
  fig.cap.fp_text = fp_text_lite(bold = TRUE),
  tab.align = "left",
  tab.cap.style = "Table Caption",
  tab.cap.pre = "Table ",
  tab.cap.sep = ". ",
  tab.cap.fp_text = fp_text_lite(bold = TRUE))

set_flextable_defaults(
  font.family = "Arial", 
  font.size = 9, 
  big.mark = "", 
  table.layout = "autofit")

tab_num = run_autonum(seq_id = "table", bkm = NULL)
fig_num = run_autonum(seq_id = "figure", bkm = NULL)

```

```{r data-formatting}

PARK <- params$PARK
YEAR <- params$YEAR
# Park long name
PARKL <- ifelse(PARK == "SAGW", 
                "the Tucson Mountain District of Saguaro National Park",
                ifelse(PARK == "CHIR", "Chiricahua National Monument",
                       "Organ Pipe Cactus National Monument"))


source("src/photo-data/format-mammal-data.R")
source("src/functions.R")

# Load sampling occasion data
occasions <- read.csv(paste0("data/occasions/occasions-", PARK, ".csv"))
```

Use the text and outputs below to populate the text highlighted in yellow and the sections that tell you to 
copy from the Rmd output in the Annual Report template on Teams. In general, the yellow in the overview and 
key points can be populated once you've finished the results section.

We don't want to include all outputs for all species. The idea is that someone looks at the outputs and 
selects examples to include in the report. That may mean focusing on a few species or a few themes. 
You will also need to produce publication quality graphics for your figures of interest. 

# Methods

## Single-species single-season occupancy models

```{r data-prep}

# Get list of species that we ran occupancy models for (and list of files with 
# model output)
spp_rds <- list.files(path = "output/single-season-models/", 
                      pattern = paste0(PARK, "-", YEAR),
                      full.names = FALSE)
species_rds <- str_remove(spp_rds, ".rds")
spp_table <- data.frame(Species_code = str_sub(species_rds, 
                                               11, 
                                               nchar(species_rds)))
spp_table$common <- species$Common_name[match(spp_table$Species_code,
                                              species$Species_code)]
nspp <- nrow(spp_table)
spp_code <- spp_table$Species_code

# Extract MCMC parameters from one of these model objects
model_list <- readRDS(paste0("output/single-season-models/", spp_rds[1]))
n_samples <- model_list$model$n.samples
n_thin <- model_list$model$n.thin
n_burn <- model_list$model$n.burn
n_chains <- model_list$model$n.chains
n_post <- model_list$model$n.post

# Load multi-layer raster with spatial data for park
park_raster <- readRDS(paste0("data/covariates/spatial-cov-", PARK, ".rds"))
# We have two distance-to-boundary layers, one that applies to the entire park
# boundary and one that applies to boundaries that are adjacent to unprotected
# lands (boundaryUP). For now, we'll remove the original boundary layer.
park_raster <- subset(park_raster, "boundary", negate = TRUE)
names(park_raster)[names(park_raster) == "boundaryUP"] <- "boundary"

# Extract dataframe with covariate values at each camera location
spatial_covs <- model_list$data$occ.covs

# Load general information about covariates
covariates <- read.csv("data/covariates/covariates.csv")

```

For each species with a sufficient number of detections (here, `r nspp` 
species), we used single-season occupancy models to estimate the probability of 
occurrence and the probability of detection given occurrence (MacKenzie et al. 
2002). First, we defined the season as those days between the first deployment date and 
the last retrieval date when ≥ 60% of the cameras were operational. We then delineated
consecutive 7-day sampling occasions within the season, with the first sampling occasion
beginning on the first day ≥ 60% of the cameras were operational. For each species and 
camera location, we generated encounter histories for each camera location, where a "1" 
denotes that the species was detected at least once during a sampling occasion and a "0"
indicates that the species was not detected. For example, an encounter history of "10011"
would indicate that a species was photographed at least once during the first, fourth, and fifth sampling occasions and was not photographed during the second and third sampling 
occasions. 

We used a Bayesian framework to estimate model parameters, as this made it 
easier to estimate derived parameters (e.g., proportion of area occupied across 
the entire park) with associated uncertainties. We fit models in R using the 
spOccupancy package (Doser et al. 2022). For each model, we ran `r n_chains` 
Markov chains initiated at random values for `r n_samples` iterations. We 
discarded the first `r n_burn` iterations and retained 1 of every `r n_thin` 
iterations thereafter, using the remaining `r n_chains * n_post` samples (across 
all the chains) to summarize the posterior distribution.

## Covariates and model selection

```{r covariates-by-park}

topo <- "topographic (aspect, elevation, slope)"
anthro <- "anthropogenic (distance to nearest road, park boundary, trail, point-of-interest)"
veg_related <- "vegetation-related (vegetation classes and distance to nearest wash)"
burn_related <- "burn-related (burn severity during 2011 fire)"

cov_list <- ifelse(PARK == "SAGW",
                   paste0(topo, ", ", veg_related, ", and ", anthro),
                   ifelse(PARK == "ORPI",
                          paste0(topo, " and ", anthro),
                          paste0(topo, ", ", burn_related, ", and ", anthro)))

```

We identified a number of `r cov_list` spatial covariates for `r PARKL` that 
could explain variation in occurrence probabilities. For each species, we 
assembled a set of candidate models where each model included one element from 
each covariate category, excluding any combination of covariates that were 
highly correlated (pairwise correlation coefficient, |r| > 0.7). In each 
candidate model, we allowed detection probability to vary as a function of day 
(using linear and quadratic terms), effort (proportion of days during each 
sampling occasion that the camera was operational), and the experience of 
deployment personnel. We used widely applicable information criterion (WAIC) to 
identify the best supported candidate model, and then removed any covariates 
with little to no explanatory power (95% credible intervals that widely 
overlapped zero). When necessary to estimate spatial variation in occupancy
or detection, we used camera location as a random effect. 
We used the resulting model for all inferences.

# Results 

## Effort
```{r effort}

# Subset events data and add a numeric camera ID
events <- events %>%
  filter(Park == PARK, d_yr == YEAR) %>%
  mutate(locnum = as.numeric(as.factor(loc))) %>%
  as.data.frame()
deploy_start <- format(min(events$d_date), "%B %d")
deploy_end <- format(max(events$d_date), "%B %d")
retr_start <- format(min(events$r_date), "%B %d")
retr_end <- format(max(events$r_date), "%B %d")

# count number of each camera type
cam_type <- events %>% group_by(CameraType) %>% count() %>% rename(count=n) %>% arrange(count) %>% mutate(CamText = paste(count, CameraType))
cam_type_text <- ifelse(cam_type$count[1] == sum(cam_type$count), as.character(cam_type$CameraType[1]), paste(unlist(cam_type$CamText), collapse =", "))

# Occasions by year
occasions_yr <- occasions %>%
  group_by(Park, yr) %>%
  count()

# Format sampling occasion data
#occasions <- read.csv(paste0("data/occasions/occasions-", PARK, ".csv"))
occasions <- occasions %>%
  filter(yr %in% YEAR) %>%
  mutate(start_yday = yday(start),
         end_yday = yday(end),
         mid_yday = round((start_yday + end_yday)/2)) %>%
  arrange(yr, occasion) 
season_start <- format(as.Date(occasions$start[1]), "%B %d")
season_end <- format(as.Date(occasions$end[nrow(occasions)]), "%B %d")

# Function to create chart with deployments
ggcust_segs <- function(dat, park, year, xlims, occ){
  ggplot() +
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = d_date, xend = r_date, y = locnum, yend = locnum),
                 linewidth = 0.3, color = "dodgerblue3") + 
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = d_date, xend = d_date, y = locnum+0.4, yend = locnum-0.4),
                 linewidth = 0.3, color = "dodgerblue3") + 
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = r_date, xend = r_date, y = locnum+0.4, yend = locnum-0.4),
                 linewidth = 0.3, color = "dodgerblue3") +
    geom_vline(xintercept = as.Date(occ$start), color = "gray50") + 
    geom_vline(xintercept = as.Date(occ$end[nrow(occ)]), color = "gray50") +
    labs(x = "", y = "Camera number") + 
    scale_x_date(limits = xlims, date_labels = "%d-%b") +
    theme(text=element_text(size = 10),
          axis.title.x=element_blank(),
          plot.margin = margin(0.1, 0.2, 0.2, 0.2, unit = "cm"))
}

xmin <- as.Date(occasions$start[1]) - 15
xmax <- as.Date(occasions$end[nrow(occasions)]) + 15

segs <- ggcust_segs(events, PARK, YEAR, xlims = as.Date(c(xmin, xmax)),
                    occ = occasions)
```

A total of `r nrow(events)` cameras (`r cam_type_text`) were deployed in `r PARKL` between 
`r deploy_start` and `r deploy_end` and were retrieved between 
`r retr_start` and `r retr_end`, `r YEAR`. We delineated a total of 
`r nrow(occasions)` sampling occasions that were each `r occasions$duration[1]` 
days long. The first sampling occasion began on `r season_start` and the last sampling occasion ended on `r season_end`. Community scientists, park staff, and/or partner organizations typically assist with the fieldwork associated with camera deployments and retrievals. In `r YEAR`, __##__ volunteers and __##__ interns and staff from various parks and partner organizations helped deploy and retrieve cameras in `r PARKL`. We are grateful for their support.

```{r deployment-table}

occ_short <- occasions %>%
  select(c(occasion, start, end)) %>%
  rename(Occasion = occasion,
         Start = start,
         End = end)

occtable_cap <- paste0("Start and end dates for each sampling occasion in ",
                       PARKL, ", ", YEAR, ".")

occ_ftable <- flextable(occ_short) %>%
  align(align = "left", part = "all") %>%
  bold(bold = TRUE, part = "header") %>%
  set_caption(caption = occtable_cap, autonum = tab_num) %>%
  add_footer_lines("")

```

```{r tab-deploy, ft.align = "left", tab.id = "table"}

occ_ftable

```

```{r deployment-plot, fig.id = "figure", fig.cap = segs_cap}

segs_cap <- paste0("Camera deployments and sampling occasions in ", PARKL, ", ",
  YEAR, ". Each horizontal blue line represents the period over which a ",
  "camera was operational, from the date the camera was deployed through the ", 
  "date the camera was retrieved. Gray vertical lines denote the beginning ",
  "and end of the ", nrow(occasions), " consecutive sampling occasions.")

segs

```

## Detections
```{r detections}

# Clean up species table
species <- species %>%
  select(-c(TSN, Family, Nativeness)) 
species$Species[species$Species_code == "FOX"] <- "Vulpes or Urocyon sp."

# Filter detection data
# within park over time
dat_park <- dat %>%
  filter(Park == PARK) %>%
  group_by(Park, yr) %>%
  count()
total_photos <- filter(dat_park, Park == PARK & yr == YEAR)$n
# within park and within given years' occasion start & end
dat <- dat %>%
  filter(Park == PARK & yr == YEAR)
nphotos <- dat %>%
  group_by(Species_code) %>%
  summarize(n_photos = length(datetime),
            n_locs = length(unique(loc))) %>%
  data.frame()
dat <- dat %>%
  filter(obsdate >= occasions$start[1] & 
           obsdate <= occasions$end[nrow(occasions)])

# Look at detection data for various species
# Where detection is max of one per sampling occasion at each location
detects <- read.csv(paste0("output/species-detections-byyr-", PARK, ".csv"))

detects_new <- detects %>%
  mutate(visit = ifelse(yr == YEAR, "Current", ifelse(yr > YEAR, "Future", "Past"))) %>%
  filter(visit != "Future") %>%
  ungroup() %>%
  group_by(Park, spp, visit) %>%
  summarize(sumdetects = sum(ndetects), .groups="keep") %>%
  pivot_wider(., names_from="visit", values_from="sumdetects") %>%
  filter(Past==0 & Current > 0) %>%
  left_join(species, by = c("spp" = "Species_code")) %>%
  mutate(name = paste0(Common_name," (",Species,")", sep=""))

detects_new_run = ifelse(nrow(detects_new) > 0, TRUE, FALSE)
detects_new_text = paste("In ",YEAR, ", we detected ",paste(unlist(detects_new$name), collapse=", "), " for the first time during a sampling occasion. ", sep="")

# for selected year
detects <- detects %>%
  dplyr::filter(yr == YEAR) %>%
  select(c(spp, ndetects)) %>%
  rename(Species_code = spp,
         n_detects = ndetects)

nphotos <- nphotos %>%
  left_join(detects, by = "Species_code") %>%
  arrange(desc(n_photos)) %>%
  left_join(species, by = "Species_code") %>%
  relocate(Common_name:Species, .before = n_photos) %>%
  relocate(n_detects, .after = n_photos) %>%
  select(-Species_code)

species_type <- nphotos %>%
  mutate(separate_wider_delim(., cols=Species, delim=" ", names=c("Genus", "SpEp"), too_few = "align_start", too_many="drop")) %>%
  mutate(Type = ifelse(is.na(SpEp),"Genera","Species")) %>%
  mutate(Type = ifelse(Common_name == "unknown animal", "Unknown", Type))

# count species and genera separately
species_count <- nrow(filter(species_type, Type == "Species"))
genera_count <- nrow(filter(species_type, Type == "Genera"))
```

We captured `r nrow(dat)` photos and detected a total of `r species_count` mammal species plus `r genera_count` mammalian 
families or genera on the `r nrow(events)` 
cameras during the `r nrow(occasions)` sampling occasions (weeks) in `r YEAR` (Table #). 
`r if(detects_new_run){detects_new_text}`

**Take a look and see if there are any interesting or notable detections, even if there weren’t many of them. If there were new detections, those will be mentioned above.**


```{r detections-table}

nphotos_cap <- paste0("Mammal species detected in ",
  PARKL, " in ", YEAR, 
  ". No. photos is the total number of photographs obtained (multiple photos ",
  "may occur at the same camera location in the same day) in ", YEAR, 
  ", regardless of date. No. detections is ",
  "the number of detections that could be used in an occupancy modeling ",
  "framework (maximum of one photographic detection per camera location per ",
  "sampling occasion). No. locations is the unique number of camera locations ",
  "where the species was photographed.") 
nphotos_cap_sens<-ifelse(nrow(nphotos %>% filter(Protected=="yes"))>0,paste("Note: ",nrow(nphotos %>% filter(Protected=="yes"))," protected species removed from table."),"")

nphotos_ft <- flextable(nphotos %>% filter(Protected != "yes") %>% dplyr::select(-Protected)) %>%
  align(j = 1:2, align = "left") %>%
  align(j = 3:5, align = "center") %>%
  italic(j = 2, italic = TRUE, part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  set_header_labels(Common_name = "Common name",
                    Species = "Scientific name",
                    n_photos = "No. photos",
                    n_detects = "No. detections",
                    n_locs = "No. locations") %>%
  set_caption(caption = paste(nphotos_cap, nphotos_cap_sens), autonum = tab_num) %>%
  add_footer_lines("")

```

```{r tab-detects, ft.align = "left", tab.id = "table"}

nphotos_ft

```

```{r spp-loop, results = "asis"}

modelfile_base <- paste0(getwd(), "/output/single-season-models/")
knitchild_base <- paste0(getwd(), "/src/")

child <- lapply(spp_code, function(x) {
  SPECIES <- x
  modelfile <- paste0(modelfile_base, PARK, "-", YEAR, "-",  SPECIES, ".rds")
  model_list <- readRDS(modelfile)
  knitr::knit_child(paste0(knitchild_base, "single-season-report-spp.Rmd"),
                    envir = environment(),
                    quiet = TRUE)
})
cat(unlist(child), sep = "\n")

```
