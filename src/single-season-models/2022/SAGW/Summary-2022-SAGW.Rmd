---
title: "Summary of camera trap data, SAGW, 2022"
date: "2023-06-06"
output: 
  word_document:
    reference_docx: "../../../word-styles-01.docx"
---

```{r setup, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_knit$set(root.dir = "../../../../" )

library(lubridate)
library(tidyverse)
library(pander)
library(terra)
library(spOccupancy)
library(tidyterra)

panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

```

# Effort
```{r effort, echo = FALSE}
source("src/functions.R")
source("src/photo-data/format-mammal-data.R")

# Select park ("CHIR", "ORPI", or "SAGW") and year of interest 
PARK <- "SAGW"
YEAR <- 2022

# Park long name
PARKL <- ifelse(PARK == "SAGW", 
                "the Tucson Mountain District of Saguaro National Park",
                ifelse(PARK == "CHIR", "Chiricahua National Monument",
                       "Organ Pipe Cactus National Monument"))

# Subset events data and add a numeric camera ID
events <- events %>%
  filter(Park == PARK, d_yr == YEAR) %>%
  mutate(locnum = as.numeric(as.factor(StdLocName))) %>%
  as.data.frame()

# Load sampling occasion data
occasions <- read.csv("data/occasions/occasions-all-parks.csv")
occasions <- occasions %>%
  filter(Park == PARK) %>%
  filter(yr %in% YEAR) %>%
  arrange(yr, occasion)

# Function to create chart with deployments
ggcust_segs <- function(dat, park, year, xlims, occ){
  ggplot() +
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = d_date, xend = r_date, y = locnum, yend = locnum),
                 linewidth = 0.3, color = "dodgerblue3") + 
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = d_date, xend = d_date, y = locnum+0.4, yend = locnum-0.4),
                 linewidth = 0.3, color = "dodgerblue3") + 
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = r_date, xend = r_date, y = locnum+0.4, yend = locnum-0.4),
                 linewidth = 0.3, color = "dodgerblue3") +
    geom_vline(xintercept = as.Date(occ$start), color = "gray50") + 
    geom_vline(xintercept = as.Date(occ$end[nrow(occ)]), color = "gray50") +
    labs(x = "", y = "Camera number") + 
    scale_x_date(limits = xlims, date_labels = "%b") +
    theme(text=element_text(size = 10),
          axis.title.x=element_blank(),
          plot.margin = margin(0.1, 0.2, 0.2, 0.2, unit = "cm"))
}

xmin <- paste0(YEAR, "-01-01")
if (PARK == "SAGW") {
  xmax <- paste0(YEAR, "-03-15")
} else {
  xmax <- paste0(YEAR, "-12-31")
}

segs <- ggcust_segs(events, PARK, YEAR, xlims = as.Date(c(xmin, xmax)),
                    occ = occasions)
```

A total of `r nrow(events)` cameras were deployed in SAGW between 
`r min(events$d_date)` and `r max(events$d_date)` and were retrieved between 
`r min(events$r_date)` and `r max(events$r_date)`. We delineated a total of 
`r nrow(occasions)` sampling occasions that were each `r occasions$duration[1]` 
days long.\

```{r deployment-table, echo = FALSE}
occ_short <- occasions %>% 
  select(c(occasion, start, end)) %>%
  rename(Occasion = occasion,
         Start = start,
         End = end)

pander(occ_short,
       justify = c("center", "left", "left"),
       style = "simple")

```

\
In the figure below, each horizontal blue line represents a camera deployment. 
The gray vertical lines denote the beginning and end of the `r nrow(occasions)`
consecutive sampling occasions.\

```{r deployment-plot, fig.width = 5, fig.height = 4, echo = FALSE}
segs
```

# Detections
```{r detections, message = FALSE, warning = FALSE, echo = FALSE}

# Clean up species table
species <- species %>%
  select(-n)
species$Species[species$Species_code == "SKUNK"] <- "Mephitidae"
species$Species[species$Species_code == "UNCA"] <- "Canidae"

# Filter detection data
dat <- dat %>%
  filter(Park == PARK & yr == YEAR) %>%
  filter(obsdate >= occasions$start[1] & 
           obsdate <= occasions$end[nrow(occasions)])
nphotos <- dat %>%
  group_by(Species_code) %>%
  summarize(n_photos = length(datetime),
            n_locs = length(unique(LocationName))) %>%
  arrange(desc(n_photos)) %>%
  left_join(species, by = "Species_code") %>%
  relocate(Common_name:Species, .before = n_photos) %>%
  data.frame()

# Look at detection data for various species
# Where detection is max of one per sampling occasion at each location
detects <- read.csv("output/species-detections-byparkyr.csv", header = TRUE)
detects <- detects %>%
  dplyr::filter(Park == PARK & yr == YEAR) %>%
  select(c(spp, ndetects)) %>%
  rename(Species_code = spp,
         n_detects = ndetects)

nphotos <- nphotos %>%
  left_join(detects, by = "Species_code") %>%
  relocate(n_detects, .after = n_photos) %>%
  select(-Species_code)

```

We detected a total of `r nrow(nphotos)` mammal species on the `r nrow(events)`
cameras during the `r nrow(occasions)` sampling occasions. For each species in 
the table below, we list the total number of photographs obtained (multiple 
photos may occur at the same camera location in the same day), the number of 
detections to be used in an occupancy modeling framework (maximum of one 
detection per location per sampling period), and unique number of camera 
locations where the species was photographed.\

```{r detections-table, echo = FALSE}

colnames(nphotos) <- c("Common name", "Scientific name", "No. photos",
                       "No. detections", "No. locations")
pander(nphotos, 
       justify = c("left", "left", "center", "center", "center"),
       emphasize.italics.cols = 2,
       style = "simple")

```

# Modeling approach

## Occupancy models

```{r data-prep, echo = FALSE}

# Get list of species that we ran occupancy models for (and list of files with 
# model output)
spp_rds <- list.files(path = "output/single-season-models/", 
                      pattern = ".rds",
                      full.names = FALSE)
spp_table <- data.frame(Species_code = str_sub(spp_rds, 6, 9))
spp_table$common <- species$Common_name[match(spp_table$Species_code,
                                              species$Species_code)]
nspp <- nrow(spp_table)

# Extract MCMC parameters from one of these model objects
model_list <- readRDS(paste0("output/single-season-models/", spp_rds[1]))
n_samples <- model_list$model$n.samples
n_thin <- model_list$model$n.thin
n_burn <- model_list$model$n.burn
n_chains <- model_list$model$n.chains
n_post <- model_list$model$n.post

# Load multi-layer raster with spatial data for park
park_raster <- readRDS(paste0("data/covariates/spatial-cov-", PARK, ".rds"))
# We have two distance-to-boundary layers, one that applies to the entire park
# boundary and one that applies to boundaries that are adjacent to unprotected
# lands (boundaryUP). For now, we'll remove the original boundary layer.
park_raster <- subset(park_raster, "boundary", negate = TRUE)
names(park_raster)[names(park_raster) == "boundaryUP"] <- "boundary"

# Extract dataframe with covariate values at each camera location
spatial_covs <- model_list$data$occ.covs

# Load general information about covariates
covariates <- read.csv("data/covariates/covariates.csv")

```

For each species with a sufficient number of detections ($\ge 5$% detection
rate; here, `r nspp` species), we used single-season occupancy models to 
estimate the probability of occurrence and the probability of detection given 
occurrence (MacKenzie et al. 2002). To estimate these parameters, we generated 
encounter histories for each camera location, where a "1" denotes that the 
species was detected at least once during a sampling occasion and a "0" 
indicates that the species was not detected. For example, an encounter history 
of "10011" would indicate that a species was photographed at least once during 
the first, fourth, and fifth sampling occasions and was not photographed during 
the second and third sampling occasions. 

We used a Bayesian framework to estimate model parameters, as this made it 
easier to estimate derived parameters (e.g., proportion of area occupied across 
the entire park) with associated uncertainties and to incorporate random effects 
that can account for uncertainties beyond that explained by covariates in the 
model. We fit models in R using the spOccupancy package (Doser et al. 2022). For 
each model, we ran `r n_chains` Markov chains initiated at random values for 
`r n_samples` iterations. We discarded the first `r n_burn` iterations and 
retained 1 of every `r n_thin` iterations thereafter, using the remaining 
`r n_chains * n_post` samples (across all the chains) to summarize the posterior 
distribution.

## Model selection

We identifed a number of spatial covariates for `r PARKL` that could explain
variation in occurrence probabilities, detection probabilities, or both.

Something about where we obtained spatial data?

- candidate model set (general)
- how a model for inference was selected


# Species 1 (create species sections in a loop since the number of species will change across parks and years?)


```{r CALA-test-model, echo = TRUE}

i = 1
SPECIES <- spp_table$Species_code[i]
spp_name <- tolower(spp_table$common[i])
spp_plural <- paste0(spp_name, "s")

# Load best model and attributes
model_list <- readRDS(paste0("output/single-season-models/", PARK, "-",
                             SPECIES, "-", YEAR, ".rds"))
best <- model_list$model
psi_model <- model_list$psi_model
p_model <- model_list$p_model


# Extract names of covariates (with and without "_z" subscripts) from best model
psi_covs_z <- create_cov_list(psi_model)
if (length(psi_covs_z) == 1 & any(psi_covs_z == "1")) {
  psi_covs_z <- character(0)
  psi_covs <- character(0)
} else {
  psi_covs <- psi_covs_z %>% str_remove_all(pattern = "_z")
}
p_covs_z <- create_cov_list(p_model)
if (length(p_covs_z) == 1 & any(p_covs_z == "1")) {
  p_covs_z <- character(0)
  p_covs <- character(0)
} else {
  p_covs <- p_covs_z %>% str_remove_all(pattern = "_z")
}

# Create table with summary stats that can be saved to file
occ_estimates <- parameter_estimates(model = best,
                                     parameter = "occ",
                                     lower_ci = 0.025,
                                     upper_ci = 0.975)
det_estimates <- parameter_estimates(model = best,
                                     parameter = "det",
                                     lower_ci = 0.025,
                                     upper_ci = 0.975)
occ_estimates <- occ_estimates %>%
  rename(Covariate = Parameter) %>%
  mutate(Parameter = "Occurrence", .before = "Covariate")
det_estimates <- det_estimates %>%
  rename(Covariate = Parameter) %>%
  mutate(Parameter = "Detection", .before = "Covariate")
estimates <- rbind(occ_estimates, det_estimates)

psi_model
p_model
psi_covs_z
psi_covs
p_covs_z
p_covs
head(covariates)

# Add something to calculate the number of covariates for each parameter
# Need to create wording to describe vegclasses and quadratic effects

```

## Model used for inference

The highest-ranking model for `r spp_plural` included XX covariates in the 
occurrence part of the model and XX covariates in the detection part of the
model.

<br>

**Table X.** Parameter estimates from a model for `r spp_name` in `r PARKL`, 
`r YEAR`. SD = Standard deviation and 95% CI = 95% credible interval. Rhat
values between 1 and 1.05 indicate that the model has converged. ESS = effective
sample size; values > 400 are usually sufficient. f values indicate the
proportion of posterior samples that are < 0 if the mean is < 0 or the
proportion of samples that are > 0 if the mean is > 0. Estimates are on the 
logit scale and all continuous covariates have been standardized by their 
respective means and standard deviations.

<br>

```{r CALA-test-estimates, echo = FALSE}

################################
# Replace elev_z with elevation (note about standardizing in table or caption)
# Replace vegclass2 with better name? Veg Class 2?

estimates %>%
  rename(LowerCI = "Lower95%",
         UpperCI = "Upper95%") %>%
  mutate(across(Mean:UpperCI, function(x) round(x, 2))) %>%
  mutate("95% CI" = paste0(LowerCI, ", ", UpperCI)) %>%
  select(-c(Median, LowerCI, UpperCI, exclude0)) %>%
  relocate("95% CI", .after = SD) %>%
  pander(justify = c(rep("right", 4), "center", rep("right", 3)),
         digits = 2,
         big.mark = "",
         style = "simple")

```

\
Table with overall estimate (or estimates by vegclass)

```{r CALA-test-predmap, echo = FALSE}

# Create spatial predictions IF there are spatial covariates in the occurrence
# part of the model. NOTE: this can take several minutes to run.

# if (length(psi_covs) > 0) {
  
#   source("src/single-season-models/spOccupancy-predictions.R")
# }

```

## Estimated occurrence probabilities

Map

```{r CALA-test-covariate-effects, echo = FALSE}

```

## Estimated covariate effects on occurrence and/or detection probabilities

Figures with captions

Two examples of how to do things in a loop:

```{r echo = FALSE, results = "asis"}
# input <- data.frame(
#   name = LETTERS[1:4],
#   data = runif(n = 4),
#   text = replicate(4, paste(sample(x = LETTERS, size = 100, replace = TRUE), collapse = "")),
#   stringsAsFactors = FALSE)
# 
# template <- "## This is section %s
# Section data is `%0.2f`.
# Additional section text is: %s.
# 
# " # don't forget the newline
# 
# for (i in seq(nrow(input))) {
#   current <- input[i, ]
#   cat(sprintf(template, current$name, current$data, current$text))
# }
```



```{r, mtcars-plots, echo = FALSE, results = 'asis'}
# for (i in names(mtcars)) {
#   cat('\n\n# Summary of the variable `', i, '`\n\n')
#   x <- mtcars[, i]
#   if (length(unique(x)) <= 6) {
#     cat('`', i, '` is a categorical variable.\n\n')
#     plot(table(x), xlab = i, ylab = 'Frequency', lwd = 10)
#   } else {
#     cat('Histogram for the continuous variable `', i, '`.\n\n')
#     hist(x, xlab = i, main = '')
#   }
# }
```







