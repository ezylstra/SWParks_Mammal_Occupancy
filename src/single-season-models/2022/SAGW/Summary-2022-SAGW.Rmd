---
title: "Summary of camera trap data, SAGW, 2022"
date: "2023-06-06"
output: 
  word_document:
    reference_docx: "../../../word-styles-01.docx"
---

```{r setup, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_knit$set(root.dir = "../../../../" )

library(lubridate)
library(tidyverse)
library(pander)
library(terra)
library(spOccupancy)
library(tidyterra)

panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

```

# Effort
```{r effort, echo = FALSE}
source("src/functions.R")
source("src/photo-data/format-mammal-data.R")

# Select park ("CHIR", "ORPI", or "SAGW") and year of interest 
PARK <- "SAGW"
YEAR <- 2022

# Park long name
PARKL <- ifelse(PARK == "SAGW", 
                "Saguaro National Park - Tucson Mountain District",
                ifelse(PARK == "CHIR", "Chiricahua National Monument",
                       "Organ Pipe Cactus National Monument"))

# Subset events data and add a numeric camera ID
events <- events %>%
  filter(Park == PARK, d_yr == YEAR) %>%
  mutate(locnum = as.numeric(as.factor(StdLocName))) %>%
  as.data.frame()

# Load sampling occasion data
occasions <- read.csv("data/occasions/occasions-all-parks.csv")
occasions <- occasions %>%
  filter(Park == PARK) %>%
  filter(yr %in% YEAR) %>%
  arrange(yr, occasion)

# Function to create chart with deployments
ggcust_segs <- function(dat, park, year, xlims, occ){
  ggplot() +
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = d_date, xend = r_date, y = locnum, yend = locnum),
                 linewidth = 0.3, color = "dodgerblue3") + 
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = d_date, xend = d_date, y = locnum+0.4, yend = locnum-0.4),
                 linewidth = 0.3, color = "dodgerblue3") + 
    geom_segment(filter(dat, Park == park & d_yr == year),
                 mapping = aes(x = r_date, xend = r_date, y = locnum+0.4, yend = locnum-0.4),
                 linewidth = 0.3, color = "dodgerblue3") +
    geom_vline(xintercept = as.Date(occ$start), color = "gray50") + 
    geom_vline(xintercept = as.Date(occ$end[nrow(occ)]), color = "gray50") +
    labs(x = "", y = "Camera number") + 
    scale_x_date(limits = xlims, date_labels = "%b") +
    theme(text=element_text(size = 10),
          axis.title.x=element_blank(),
          plot.margin = margin(0.1, 0.2, 0.2, 0.2, unit = "cm"))
}

xmin <- paste0(YEAR, "-01-01")
if (PARK == "SAGW") {
  xmax <- paste0(YEAR, "-03-15")
} else {
  xmax <- paste0(YEAR, "-12-31")
}

segs <- ggcust_segs(events, PARK, YEAR, xlims = as.Date(c(xmin, xmax)),
                    occ = occasions)
```

A total of `r nrow(events)` cameras were deployed in SAGW between 
`r min(events$d_date)` and `r max(events$d_date)` and were retrieved between 
`r min(events$r_date)` and `r max(events$r_date)`. We delineated a total of 
`r nrow(occasions)` sampling occasions that were each `r occasions$duration[1]` 
days long.\

```{r deployment-table, echo = FALSE}
occ_short <- occasions %>% 
  select(c(occasion, start, end)) %>%
  rename(Occasion = occasion,
         Start = start,
         End = end)

pander(occ_short,
       justify = c("center", "left", "left"),
       style = "simple")

```

\
In the figure below, each horizontal blue line represents a camera deployment. 
The gray vertical lines denote the beginning and end of the `r nrow(occasions)`
consecutive sampling occasions.\

```{r deployment-plot, fig.width = 5, fig.height = 4, echo = FALSE}
segs
```

# Detections
```{r detections, message = FALSE, warning = FALSE, echo = FALSE}

# Clean up species table
species <- species %>%
  select(-n)
species$Species[species$Species_code == "SKUNK"] <- "Mephitidae"
species$Species[species$Species_code == "UNCA"] <- "Canidae"

# Filter detection data
dat <- dat %>%
  filter(Park == PARK & yr == YEAR) %>%
  filter(obsdate >= occasions$start[1] & 
           obsdate <= occasions$end[nrow(occasions)])
nphotos <- dat %>%
  group_by(Species_code) %>%
  summarize(n_photos = length(datetime),
            n_locs = length(unique(LocationName))) %>%
  arrange(desc(n_photos)) %>%
  left_join(species, by = "Species_code") %>%
  relocate(Common_name:Species, .before = n_photos) %>%
  data.frame()

# Look at detection data for various species
# Where detection is max of one per sampling occasion at each location
detects <- read.csv("output/species-detections-byparkyr.csv", header = TRUE)
detects <- detects %>%
  dplyr::filter(Park == PARK & yr == YEAR) %>%
  select(c(spp, ndetects)) %>%
  rename(Species_code = spp,
         n_detects = ndetects)

nphotos <- nphotos %>%
  left_join(detects, by = "Species_code") %>%
  relocate(n_detects, .after = n_photos) %>%
  select(-Species_code)

```

We detected a total of `r nrow(nphotos)` mammal species on the `r nrow(events)`
cameras during the `r nrow(occasions)` sampling occasions. For each species in 
the table below, we list the total number of photographs obtained (multiple 
photos may occur at the same camera location in the same day), the number of 
detections to be used in an occupancy modeling framework (maximum of one 
detection per location per sampling period), and unique number of camera 
locations where the species was photographed.\

```{r detections-table, echo = FALSE}

colnames(nphotos) <- c("Common name", "Scientific name", "No. photos",
                       "No. detections", "No. locations")
pander(nphotos, 
       justify = c("left", "left", "center", "center", "center"),
       emphasize.italics.cols = 2,
       style = "simple")

```

# Modeling approach

## Occupancy models

For each species with a sufficient number of detections (\ge 5% detection rate), 
we used single-season occupancy models to estimate the probability of occurrence
and the probability of detection given occurrence (MacKenzie et al. 2002). To 
estimate these parameters, we generate encounter histories for each camera
location, where a "1" denotes that the species was detected at least once during 
a sampling occasion and a "0" indicates that the species was not detected. For
example, an encounter history of "10011" would indicate that a species was
photographed at least once during the 1st, 4th, and 5th sampling occasions and 
was not photographed during the 2nd and 3rd sampling occasions. 

We used a Bayesian framework to estimate model parameters as this made it easier
to estimate derived parameters (e.g., proportion of area occupied across the
entire park) with associated uncertainties and incorporate random effects to
account for uncertainties beyond that explained by covariates in the model. We
ran analysis in R using the spOccupancy package (CITES).  

For each model, we used 3 chains, each with 8000 samples including 4000 burn, 
thinning by 8. Left with 1500 samples across all chains for posterior inference.

## Model selection

We characterized ...

We extracted a number of spatial covariates for `r PARKL` that could explain
variation in occurrence probabilities, detection probabilities, or both.

- candidate model set (general)
- how a model for inference was selected

# Species 1 (create species sections in a loop since the number of species will change across parks and years?)


```{r CALA-test-model, echo = FALSE}

# Load best model and attributes
model_list <- readRDS(paste0("output/single-season-models/", PARK, "-CALA-", 
                             YEAR, ".rds"))
model <- model_list$model
psi_model <- model_list$psi_model
p_model <- model_list$p_model


# Extract names of covariates (with and without "_z" subscripts) from best model
psi_covs_z <- create_cov_list(psi_model)
if (length(psi_covs_z) == 1 & any(psi_covs_z == "1")) {
  psi_covs_z <- character(0)
  psi_covs <- character(0)
} else {
  psi_covs <- psi_covs_z %>% str_remove_all(pattern = "_z")
}
p_covs_z <- create_cov_list(p_model)
if (length(p_covs_z) == 1 & any(p_covs_z == "1")) {
  p_covs_z <- character(0)
  p_covs <- character(0)
} else {
  p_covs <- p_covs_z %>% str_remove_all(pattern = "_z")
}

# Create table with summary stats that can be saved to file
occ_estimates <- parameter_estimates(model = model, 
                                     parameter = "occ",
                                     lower_ci = 0.025,
                                     upper_ci = 0.975)
det_estimates <- parameter_estimates(model = model, 
                                     parameter = "det",
                                     lower_ci = 0.025,
                                     upper_ci = 0.975)
occ_estimates <- occ_estimates %>%
  rename(Covariate = Parameter) %>%
  mutate(Parameter = "Occurrence", .before = "Covariate")
det_estimates <- det_estimates %>%
  rename(Covariate = Parameter) %>%
  mutate(Parameter = "Detection", .before = "Covariate")
estimates <- rbind(occ_estimates, det_estimates)

pander(estimates, 
       justify = "right",
       style = "simple")
########## This is too wide. Could reduce digits to 2, remove comma in ESS.
########## Remove exclude0
########## remove Rhat and ESS if necessary.

```

## Model used for inference

Brief description

Table with parameter estimates (along with generic caption)

Table with overall estimate (or estimates by vegclass)

```{r CALA-test-predmap, echo = FALSE}

# Create spatial predictions IF there are spatial covariates in the occurrence
# part of the model. NOTE: this can take several minutes to run.

# if (length(psi_covs) > 0) {
#   # Load multi-layer raster with spatial data ############# ONLY NEED TO DO THIS ONCE -- put in earlier chunk
#   park_raster <- readRDS(paste0("data/covariates/spatial-cov-", PARK, ".rds"))
#   
#   # Actually need a bunch of stuff that's in the data-prep script 
#   # (eg, spatial_covs, locs_park), but that was created once a species was 
#   # selected.  Need to figure out how best to do this...
#   
#   source("src/single-season-models/spOccupancy-predictions.R")
# }

```

## Estimated occurrence probabilities

Map

```{r CALA-test-covariate-effects, echo = FALSE}

```

## Estimated covariate effects on occurrence and/or detection probabilities

Figures with captions




Two examples of how to do things in a loop:

```{r echo = FALSE, results = "asis"}
# input <- data.frame(
#   name = LETTERS[1:4],
#   data = runif(n = 4),
#   text = replicate(4, paste(sample(x = LETTERS, size = 100, replace = TRUE), collapse = "")),
#   stringsAsFactors = FALSE)
# 
# template <- "## This is section %s
# Section data is `%0.2f`.
# Additional section text is: %s.
# 
# " # don't forget the newline
# 
# for (i in seq(nrow(input))) {
#   current <- input[i, ]
#   cat(sprintf(template, current$name, current$data, current$text))
# }
```



```{r, mtcars-plots, echo = FALSE, results = 'asis'}
# for (i in names(mtcars)) {
#   cat('\n\n# Summary of the variable `', i, '`\n\n')
#   x <- mtcars[, i]
#   if (length(unique(x)) <= 6) {
#     cat('`', i, '` is a categorical variable.\n\n')
#     plot(table(x), xlab = i, ylab = 'Frequency', lwd = 10)
#   } else {
#     cat('Histogram for the continuous variable `', i, '`.\n\n')
#     hist(x, xlab = i, main = '')
#   }
# }
```







